{% extends "base.html" %}
{% block title %}Patients{% endblock %}
    {% block content %}
        <!-- Login/logout messages-->
        {% with messages = get_flashed_messages()%}
            {% if messages %}
                {% for msg in messages %}
                    <p>{{msg}}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
    <!-- Table-->
    <div>
        <table class="table" id="patientTable">
            <caption>List of patients</caption>
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Patient ID</th>
                    <th scope="col">Patient Name</th>
                    <th scope="col">Phone</th>
                    <th scope="col">Dentist ID</th>
                    <th scope="col">Update</th>
                    <th scope="col">Delete</th>
                </tr>
            </thead>
        </table>
    </div>

    <!-- Update Form -->
    <form>
        <div class="form-group" id='createUpdateForm' style="display: none">
            <div id="grid">
                <span id="createLabel">Add</span> <span id="updateLabel">update</span>Patient
            </div>
            <div class="col-sm-5">
                <!-- Patient ID -->
                <input type="hidden" name="patientId" />

                <!-- Patient Name -->
                <label for="patientName">Patient Name</label>
                <input type="text" name="patientName" class= "form-control" placeholder="e.g. John Smith" required><br />
                
                <!-- Phone -->
                <label for="phone">Phone</label>
                <input type="text" name="phone" class= "form-control" placeholder="0895481372" required><br />
                
                <!-- Dentist ID -->
                <label for="phone">Dentist ID</label>
                <input type="text" name="dentistId" class="form-control" placeholder="Leave empty if no dentist assigned"><br />
                <span><button type="submit" id="doCreateButton" onclick="doCreate()">Create</button></span>
                <span><button type="submit" id="doUpdateButton" onclick="doUpdate()">Update</button></span>
                <span><button id="goBackButton" class="delete-back" onclick="return goBack()">Back</button></span>
            </div>
        </div>
    </form>
    <div>
        <button id="showCreateButton" onclick="showCreate()">Add patient</button>
    </div>
    {% endblock %}

{% block script %}
<script type="text/javascript">
    function showCreate() {
        document.getElementById('showCreateButton').style.display = "none"
        document.getElementById('patientTable').style.display = "none"
        document.getElementById('createUpdateForm').style.display = "block"

        document.getElementById('createLabel').style.display = "inline"
        document.getElementById('updateLabel').style.display = "none"

        document.getElementById('doCreateButton').style.display = "inline"
        document.getElementById('goBackButton').style.display = "inline"
        document.getElementById('doUpdateButton').style.display = "none"

    }
    function showViewAll() {
        document.getElementById('showCreateButton').style.display = "block"
        document.getElementById('patientTable').style.display = "block"
        document.getElementById('createUpdateForm').style.display = "none"
    }
    function showUpdate(buttonElement) {
        document.getElementById('showCreateButton').style.display = "none"
        document.getElementById('patientTable').style.display = "none"
        document.getElementById('createUpdateForm').style.display = "block"

        document.getElementById('createLabel').style.display = "none"
        document.getElementById('updateLabel').style.display = "inline"

        document.getElementById('doCreateButton').style.display = "none"
        document.getElementById('doUpdateButton').style.display = "inline"
        document.getElementById('goBackButton').style.display = "inline"

        var rowElement = buttonElement.parentNode.parentNode
        var patient = getPatientFromRow(rowElement)
        populateFormWithPatient(patient)
    }
    // adapted from https://stackoverflow.com/questions/26517974/javascript-redirect-not-working-anyway/26518061#26518061
    function goBack(){
        window.location = '/';
        return false;
    }

     // Create.
     function doCreate() {
        var form = document.getElementById('createUpdateForm')
        var patient = {}
        patient.patientName = form.querySelector('input[name="patientName"]').value
        patient.phone = form.querySelector('select[name="phone"').value
        patient.dentistId = form.querySelector('input[name="dentistId"]').value
        console.log(JSON.stringify(patient))
        createPatientAjax(patient)
    }

    // Update
    function doUpdate() {
        var patient = getPatientFromForm();
        var rowElement = document.getElementById(patient.patientId);
        updatePatientAjax(patient);
        setPatientInRow(rowElement, patient);

        clearForm();
        showViewAll();
    }
    // Delete
    function doDelete(r) {
        // Confirm with the user deletion of the requested entry.
        if (!confirm('Are you sure you want to delete this entry from the database?')) {
            return false;
        }
        var tableElement = document.getElementById('patientTable');
        var rowElement = r.parentNode.parentNode;
        var index = rowElement.rowIndex;
        deletePatientAjax(rowElement.getAttribute("patientId"));
        tableElement.deleteRow(index);
    }
    
    function addPatientToTable(patient) {
        var tableElement = document.getElementById('patientTable')
        var rowElement = tableElement.insertRow(-1)
        rowElement.setAttribute('patientId', patient.patientId)
        var cell1 = rowElement.insertCell(0);
        cell1.innerHTML = patient.patientId
        var cell2 = rowElement.insertCell(1);
        cell2.innerHTML = patient.patientName
        var cell3 = rowElement.insertCell(2);
        cell3.innerHTML = patient.phone
        var cell4 = rowElement.insertCell(3);
        cell4.innerHTML = patient.dentistId
        var cell5 = rowElement.insertCell(4);
        cell5.innerHTML = '<button onclick="showUpdate(this)">Update</button>'
        var cell6 = rowElement.insertCell(5);
        cell6.innerHTML = '<button class="delete-back" onclick=doDelete(this)>Delete</button>'
    }

    function clearForm() {
        var form = document.getElementById('createUpdateForm')
        form.querySelector('input[name="patientName"]').value = ''
        form.querySelector('select[name="phone"]').value = ''
        form.querySelector('input[name="dentistId"]').value = ''
    }
    function getPatientFromRow(rowElement) {
        var patient = {}
        patient.patientId = rowElement.getAttribute('patientId')
        patient.patientName = rowElement.cells[1].firstChild.textContent
        patient.phone = rowElement.cells[2].firstChild.textContent
        patient.dentistId = rowElement.cells[3].firstChild.textContent
        return patient
    }
    function setPatientInRow(rowElement, patient) {
        rowElement.cells[0].firstChild.textContent = patient.patientId
        rowElement.cells[1].firstChild.textContent = patient.patientName
        rowElement.cells[2].firstChild.textContent = patient.phone
        rowElement.cells[3].firstChild.textContent = patient.dentistId
    }
    function populateFormWithPatient(patient) {
        var form = document.getElementById('createUpdateForm')
        form.querySelector('input[name="patientId"]').disabled = true

        form.querySelector('input[name="patientId"]').value = patient.patientId
        form.querySelector('input[name="patientName"]').value = patient.patientName
        form.querySelector('select[name="phone"]').value = patient.phone
        form.querySelector('input[name="dentistId"]').value = patient.dentistId
        return patient
    }
    function getPatientFromForm() {
        var form = document.getElementById('createUpdateForm')
        var patient = {}
        patient.patientId = form.querySelector('input[name="patientId"]').value
        patient.patientName = form.querySelector('input[name="patientName"]').value
        patient.phone = form.querySelector('select[name="phone"]').value
        patient.dentistId = form.querySelector('input[name="dentistId"]').value
        console.log(JSON.stringify(patient))
        return patient
    }
    function getAllAjax() {
        $.ajax({
            "url": "http://127.0.0.1:5000/patients",
            "method": "GET",
            "data": "",
            "dataType": "JSON",
            "error": function (xhr, status, error) {
                if (xhr.status == 404) {
                    alert('Page is not found');
                } else if (xhr.status == 500) {
                    alert('Internal Server Error.');
                } else if (error === 'parsererror') {
                    alert('Requested JSON parse failed');
                } else if (error === 'timeout') {
                    alert('Time out error');
                } else if (error === 'abort') {
                    alert('Ajax request aborted');
                } else {
                    alert('Uncaught Error.\n' + xhr.responseText + ' - Click \'OK\' and try to re-submit your entries');
                }
            },
            "success": function (result) {
                //console.log(result);
                for (patient of result) {
                    addPatientToTable(patient);
            }}
        });

    }
     function createPatientAjax(patient) {
        console.log(JSON.stringify(patient));
        $.ajax({
            "url": "http://127.0.0.1:5000/patients",
            "method": "POST",
            "data": JSON.stringify(patient),
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "success": function (result) {
                //console.log(result);
                patient.patientId = result.patientId
                addPatientToTable(patient)
                clearForm()
                showViewAll()
            },
            "error": function (xhr, status, error) {
                if (xhr.status == 404) {
                    alert('Page is not found - Click \'OK\' and try to re-submit your entries.');
                } else if (xhr.status == 500) {
                    alert('Check for empty entries - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'parsererror') {
                    alert('Requested JSON parse failed - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'timeout') {
                    alert('Time out error - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'abort') {
                    alert('Ajax request aborted - Click \'OK\' and try to re-submit your entries');
                }
                else {
                    alert('Uncaught Error.\n' + xhr.responseText + ' - Click \'OK\' and try to re-submit your entries');
                }
            }
        });
    }
    function updatePatientAjax(patient) {
        console.log(JSON.stringify(patient));
        $.ajax({
            "url": "http://127.0.0.1:5000/patients/" + encodeURI(patient.patientId),
            "method": "PUT",
            "data": JSON.stringify(patient),
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "error": function (xhr, status, error) {
                if (xhr.status == 404) {
                    alert('Page is not found - Click \'OK\' and try to re-submit your entries.');
                } else if (xhr.status == 500) {
                    alert('Check for empty entries - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'parsererror') {
                    alert('Requested JSON parse failed - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'timeout') {
                    alert('Time out error - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'abort') {
                    alert('Ajax request aborted - Click \'OK\' and try to re-submit your entries');
                }
                else {
                    alert('Uncaught Error.\n' + xhr.responseText + ' - Click \'OK\' and try to re-submit your entries');
                }
            },
            "success": function (result) {
                // console.log(result);
            }
        });
    }
    function deletePatientAjax(patientId) {
        $.ajax({
            "url": "http://127.0.0.1:5000/patients/" + encodeURI(patientId),
            "method": "DELETE",
            "data": "",
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "error": function (xhr, status, error) {
                if (xhr.status == 404) {
                    alert('Page is not found - Click \'OK\' and try to re-submit your entries.');
                } else if (xhr.status == 500) {
                    alert('Check for empty entries - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'parsererror') {
                    alert('Requested JSON parse failed - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'timeout') {
                    alert('Time out error - Click \'OK\' and try to re-submit your entries');
                } else if (error === 'abort') {
                    alert('Ajax request aborted - Click \'OK\' and try to re-submit your entries');
                }
                else {
                    alert('Uncaught Error.\n' + xhr.responseText + ' - Click \'OK\' and try to re-submit your entries');
                }
            },
            "success": function (result) {
                // console.log(result);
            }
        });
    }
    getAllAjax();
</script>
{% endblock %}
</html>